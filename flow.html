<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>Chat Flow Builder - Secuencial Corregido</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
body { margin:0; font-family:sans-serif; background:#f6f6f6; }
#toolbar { position:fixed; top:10px; left:10px; z-index:30; background:#fff; padding:8px 12px; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.15); }
button { margin-right:5px; padding:6px 10px; border:1px solid #ccc; border-radius:6px; background:#fafafa; cursor:pointer; }
svg#edges { position:fixed; top:0; left:0; width:100vw; height:100vh; pointer-events:none; z-index:5; }

.node { position:absolute; min-width:180px; background:#fff; border:2px solid #222; border-radius:8px; padding:12px 20px; box-shadow:0 4px 12px rgba(0,0,0,0.1); cursor:grab; z-index:10; user-select:none; }
.node:active { cursor:grabbing; }
.title { font-weight:600; margin-bottom:6px; font-size:14px; }
.ports { position:absolute; top:0; height:100%; display:flex; flex-direction:column; justify-content:center; gap:8px; pointer-events:none; }
.ports.left  { left:0; align-items:flex-start; padding-left:4px; }
.ports.right { right:0; align-items:flex-end;  padding-right:4px; }
.port { width:12px; height:12px; border-radius:50%; background:#444; pointer-events:auto; position:relative; }
.port:hover { background:#0ca5ff; }
.port-label { position:absolute; top:-18px; font-size:12px; background:#fff; padding:1px 4px; border-radius:4px; border:1px solid #ccc; white-space:nowrap; }
</style>
</head>
<body>

<div id="toolbar">
  <button id="addTrigger">‚ûï Trigger</button>
  <button id="addPregunta">‚ûï Pregunta</button>
  <button id="addDecision">‚ûï Decision</button>
  <button id="addAction">‚ûï Action</button>
</div>

<svg id="edges"></svg>

<script>
const svg = document.getElementById("edges");
let connections = [];
let selectedPort = null, tempPath = null;

/* Crear nodo */
function createNode(x,y,type,label,outputs=1,outputLabels=[]){
  const node = document.createElement("div");
  node.className="node";
  node.style.left=x+"px";
  node.style.top=y+"px";
  node.dataset.type=type;

  const title=document.createElement("div");
  title.className="title";
  title.textContent=label;
  node.appendChild(title);

  // input (excepto Trigger)
  const left=document.createElement("div");
  left.className="ports left";
  if(type!=="trigger"){
    const inPort=document.createElement("div");
    inPort.className="port";
    inPort.dataset.type="in";
    inPort.dataset.side="left";
    enablePort(inPort,node);
    left.appendChild(inPort);
  }
  node.appendChild(left);

  // outputs
  const right=document.createElement("div");
  right.className="ports right";
  for(let i=0;i<outputs;i++){
    const out=document.createElement("div");
    out.className="port";
    out.dataset.type="out";
    out.dataset.side="right";
    out.dataset.index=i;
    enablePort(out,node);
    if(outputLabels[i]){
      const lbl=document.createElement("div");
      lbl.className="port-label";
      lbl.textContent=outputLabels[i];
      out.appendChild(lbl);
    }
    right.appendChild(out);
  }
  node.appendChild(right);

  document.body.appendChild(node);
  enableDrag(node);
  return node;
}

/* Drag */
function enableDrag(node){
  let ox=0,oy=0;
  node.addEventListener("mousedown",e=>{
    if(e.target.classList.contains("port")) return;
    ox=e.clientX-node.offsetLeft; oy=e.clientY-node.offsetTop;
    node.style.cursor="grabbing";
    function move(ev){
      node.style.left=(ev.clientX-ox)+"px";
      node.style.top=(ev.clientY-oy)+"px";
      updateAllPaths();
    }
    function stop(){
      document.removeEventListener("mousemove",move);
      document.removeEventListener("mouseup",stop);
      node.style.cursor="grab";
    }
    document.addEventListener("mousemove",move);
    document.addEventListener("mouseup",stop);
  });
}

/* Ports */
function enablePort(port,node){
  port.addEventListener("click",e=>{
    e.stopPropagation();
    if(!selectedPort){
      if(port.dataset.type!=="out") return;
      selectedPort={port,node};
      const start=connectionPointFor(port,node);
      tempPath=createPath(start.x,start.y,start.x,start.y);
      function follow(ev){
        if(tempPath){
          const s=connectionPointFor(selectedPort.port,selectedPort.node);
          updateCurve(tempPath,s.x,s.y,ev.clientX,ev.clientY);
        }
      }
      function stop(){document.removeEventListener("mousemove",follow);document.removeEventListener("mouseup",stop);}
      document.addEventListener("mousemove",follow);
      document.addEventListener("mouseup",stop);
    }else{
      const from=selectedPort.port,to=port;
      if(from===to){cleanupTemp();return;}
      if(from.dataset.type==="out"&&to.dataset.type==="in"){
        if(canConnect(from,to) && !isDuplicateConnection(from,to) && !isInUse(from) && !isInUse(to)){
          connections.push([from,to]);
          updateAllPaths();
        }
      }
      cleanupTemp();
    }
  });
}

/* Validaci√≥n l√≥gica de conexi√≥n */
function canConnect(fromPort,toPort){
  const fromType=fromPort.closest(".node").dataset.type;
  const toType  =toPort.closest(".node").dataset.type;

  // Secuencia l√≥gica de chatbot
  if(fromType==="trigger" && (toType==="trigger" || toType==="action")) return false;
  if(fromType==="pregunta" && toType==="trigger") return false;
  if(fromType==="decision" && toType==="trigger") return false;
  if(fromType==="action" && toType==="trigger") return false;

  return true;
}

/* Helpers */
function isDuplicateConnection(a,b){return connections.some(([x,y])=>x===a && y===b);}
function isInUse(port){return connections.some(([x,y])=>x===port || y===port);}
function connectionPointFor(port,node){
  const rect=port.getBoundingClientRect();
  const nrect=node.getBoundingClientRect();
  const y=rect.top+rect.height/2;
  return (port.dataset.side==="right")
    ? {x:nrect.left+nrect.width,y}
    : {x:nrect.left,y};
}
function createPath(x1,y1,x2,y2){
  const p=document.createElementNS("http://www.w3.org/2000/svg","path");
  p.setAttribute("stroke","#666");
  p.setAttribute("stroke-width","2.5");
  p.setAttribute("fill","none");
  updateCurve(p,x1,y1,x2,y2);
  svg.appendChild(p);
  return p;
}
function updateCurve(path,x1,y1,x2,y2){
  const dx=Math.max(40,Math.abs(x2-x1)*0.45);
  path.setAttribute("d",`M ${x1},${y1} C ${x1+dx},${y1} ${x2-dx},${y2} ${x2},${y2}`);
}
function cleanupTemp(){ if(tempPath && tempPath.parentNode) tempPath.parentNode.removeChild(tempPath); tempPath=null; selectedPort=null; }
function updateAllPaths(){
  svg.innerHTML="";
  connections.forEach(([out,inP])=>{
    const oNode=out.closest(".node"), iNode=inP.closest(".node");
    const p1=connectionPointFor(out,oNode), p2=connectionPointFor(inP,iNode);
    createPath(p1.x,p1.y,p2.x,p2.y);
  });
}

/* Toolbar */
let posX=80,posY=120;
document.getElementById("addTrigger").onclick=()=>{createNode(posX,posY,"trigger","üëã Trigger",1); posX+=220;};
document.getElementById("addPregunta").onclick=()=>{createNode(posX,posY,"pregunta","‚ùì Pregunta",1,["Siguiente"]); posX+=220;};
document.getElementById("addDecision").onclick=()=>{createNode(posX,posY,"decision","‚ùì Decision",2,["Opci√≥n 1","Opci√≥n 2"]); posX+=220;};
document.getElementById("addAction").onclick=()=>{createNode(posX,posY,"action","‚ö° Action",1); posX+=220;};

// ---------------- Nod√≥s ----------------

// Trigger inicial
const triggerNode = createNode(80,120,"trigger","üëã Usuario dice Hola",1);

// Pregunta nombre
const preguntaNombre = createNode(360,120,"pregunta","‚ùì ¬øCu√°l es tu nombre?",1,["Siguiente"]);

// Decision men√∫ principal: Caf√© / Helado / Pizza
const decisionMenu = createNode(640,120,"decision","¬øQu√© deseas pedir hoy?",3,["Caf√©","Helado","Pizza"]);

// ---------------- Camino Caf√© ----------------
const preguntaSaborCafe = createNode(900,60,"decision","¬øQu√© sabor de caf√© deseas?",3,["Expreso","Americano","Capuccino"]);
const actionCafe = createNode(1160,60,"action","‚ö° Confirmar pedido Caf√©");

// ---------------- Camino Helado ----------------
const preguntaSaborHelado = createNode(900,140,"decision","¬øQu√© sabor de helado deseas?",3,["Chocolate","Vainilla","Fresa"]);
const preguntaRecipienteHelado = createNode(1160,140,"decision","¬øEn qu√© lo quieres?",2,["Cono","Vaso"]);
const actionHelado = createNode(1400,140,"action","‚ö° Confirmar pedido Helado");

// ---------------- Camino Pizza ----------------
const preguntaSaborPizza = createNode(900,220,"decision","¬øDe qu√© sabor quieres la pizza?",3,["Pepperoni","Hawaiana","Margarita"]);
const preguntaTamanoPizza = createNode(1160,220,"decision","¬øQu√© tama√±o deseas?",3,["Peque√±a","Mediana","Grande"]);
const actionPizza = createNode(1400,220,"action","‚ö° Confirmar pedido Pizza");

// ---------------- Conexiones ----------------

// Trigger ‚Üí Pregunta nombre
connections.push([
  triggerNode.querySelector(".ports.right .port"),
  preguntaNombre.querySelector(".ports.left .port")
]);

// Pregunta nombre ‚Üí Decision men√∫ principal
connections.push([
  preguntaNombre.querySelector(".ports.right .port"),
  decisionMenu.querySelector(".ports.left .port")
]);

// Decision men√∫ principal ‚Üí Caf√© / Helado / Pizza
connections.push([
  decisionMenu.querySelectorAll(".ports.right .port")[0], // Caf√©
  preguntaSaborCafe.querySelector(".ports.left .port")
]);
connections.push([
  decisionMenu.querySelectorAll(".ports.right .port")[1], // Helado
  preguntaSaborHelado.querySelector(".ports.left .port")
]);
connections.push([
  decisionMenu.querySelectorAll(".ports.right .port")[2], // Pizza
  preguntaSaborPizza.querySelector(".ports.left .port")
]);

// Caf√© ‚Üí acci√≥n
connections.push([
  preguntaSaborCafe.querySelectorAll(".ports.right .port")[0], // Expreso
  actionCafe.querySelector(".ports.left .port")
]);
connections.push([
  preguntaSaborCafe.querySelectorAll(".ports.right .port")[1], // Americano
  actionCafe.querySelector(".ports.left .port")
]);
connections.push([
  preguntaSaborCafe.querySelectorAll(".ports.right .port")[2], // Capuccino
  actionCafe.querySelector(".ports.left .port")
]);

// Helado ‚Üí recipiente ‚Üí acci√≥n
connections.push([
  preguntaSaborHelado.querySelectorAll(".ports.right .port")[0], // Chocolate
  preguntaRecipienteHelado.querySelector(".ports.left .port")
]);
connections.push([
  preguntaSaborHelado.querySelectorAll(".ports.right .port")[1], // Vainilla
  preguntaRecipienteHelado.querySelector(".ports.left .port")
]);
connections.push([
  preguntaSaborHelado.querySelectorAll(".ports.right .port")[2], // Fresa
  preguntaRecipienteHelado.querySelector(".ports.left .port")
]);

connections.push([
  preguntaRecipienteHelado.querySelectorAll(".ports.right .port")[0], // Cono
  actionHelado.querySelector(".ports.left .port")
]);
connections.push([
  preguntaRecipienteHelado.querySelectorAll(".ports.right .port")[1], // Vaso
  actionHelado.querySelector(".ports.left .port")
]);

// Pizza ‚Üí tama√±o ‚Üí acci√≥n
connections.push([
  preguntaSaborPizza.querySelectorAll(".ports.right .port")[0], // Pepperoni
  preguntaTamanoPizza.querySelector(".ports.left .port")
]);
connections.push([
  preguntaSaborPizza.querySelectorAll(".ports.right .port")[1], // Hawaiana
  preguntaTamanoPizza.querySelector(".ports.left .port")
]);
connections.push([
  preguntaSaborPizza.querySelectorAll(".ports.right .port")[2], // Margarita
  preguntaTamanoPizza.querySelector(".ports.left .port")
]);

connections.push([
  preguntaTamanoPizza.querySelectorAll(".ports.right .port")[0], // Peque√±a
  actionPizza.querySelector(".ports.left .port")
]);
connections.push([
  preguntaTamanoPizza.querySelectorAll(".ports.right .port")[1], // Mediana
  actionPizza.querySelector(".ports.left .port")
]);
connections.push([
  preguntaTamanoPizza.querySelectorAll(".ports.right .port")[2], // Grande
  actionPizza.querySelector(".ports.left .port")
]);




updateAllPaths();
document.addEventListener("click",e=>{if(!e.target.classList.contains("port")) cleanupTemp();});
</script>
</body>
</html>
