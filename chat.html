<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Chat Interactivo con JSON</title>
<style>
  body { font-family: Arial; background:#f0f0f0; margin:0; display:flex; height:100vh; }
  #chatContainer { flex:1; display:flex; flex-direction:column; }
  #messages { flex:1; padding:10px; overflow:auto; background:#fff; border-bottom:1px solid #ccc; }
  .message { margin:5px 0; padding:8px 12px; border-radius:12px; max-width:70%; }
  .user { background:#007bff; color:#fff; align-self:flex-end; }
  .bot { background:#eee; color:#000; align-self:flex-start; }
  #inputContainer { display:flex; padding:10px; background:#ddd; }
  #userInput { flex:1; padding:8px; border-radius:8px; border:1px solid #ccc; }
  #sendButton { padding:8px 12px; margin-left:5px; border:none; border-radius:8px; background:#28a745; color:white; cursor:pointer; }
  #visualizer { width:350px; background:#fff; border-left:1px solid #ccc; padding:10px; overflow:auto; }
  h3 { margin-top:0; }
  pre { background:#222; color:#0f0; padding:5px; overflow:auto; max-height:80vh; }
</style>
</head>
<body>

<div id="chatContainer">
  <div id="messages"></div>
  <div id="inputContainer">
    <input type="text" id="userInput" placeholder="Escribe tu mensaje..."/>
    <button id="sendButton">Enviar</button>
  </div>
</div>

<div id="visualizer">
  <h3>Visualización JSON</h3>
  <pre id="jsonView"></pre>
</div>

<script>
// -----------------------------
// JSON de flujo de conversación
// -----------------------------
const json = {
  "nodes": [
    {"id":1,"type":"trigger","triggers":["hola","buenas"],"next":2},
    {"id":2,"type":"question","text":"Cual es su nombre?","key":"name","options":[],"next":3},
    {"id":3,"type":"decision","text":"Ok {{name}}, que desea hoy?","options":[{"label":"cafe","next":4},{"label":"helados","next":5}]},
    {"id":4,"type":"flow","text":"Flujo Café","nodesInFlow":[{"id":6,"type":"question","text":"Cafe helado o caliente?","key":"tipoCafe","options":["helado","caliente"],"next":8}]},
    {"id":5,"type":"flow","text":"Flujo Helado","nodesInFlow":[{"id":7,"type":"question","text":"Que sabor desea fresa o vainilla?","key":"sabor","options":["fresa","vainilla"],"next":8}]},
    {"id":8,"type":"question","text":"Paga con efectivo o transferencia?","key":"payment","options":["efectivo","transferencia"],"next":9},
    {"id":9,"type":"response","text":"Gracias por su preferencia, su pedido de {{name}}, {{sabor || tipoCafe}}, pago: {{payment}} será enviado","key":"pedidoFinal"}
  ]
};

// -----------------------------
// Sesión del chat
// -----------------------------
let sessions = {}; // {sessionId: {userData:{}, messages:[], currentNode}}

// -----------------------------
// Elementos DOM
// -----------------------------
const messagesEl = document.getElementById("messages");
const userInput = document.getElementById("userInput");
const sendButton = document.getElementById("sendButton");
const jsonView = document.getElementById("jsonView");

const sessionId = "50433158947";

// Inicializar sesión
if(!sessions[sessionId]) {
  sessions[sessionId] = {
    userData:{},
    messages:[],
    currentNode: json.nodes[0] // empezar por trigger
  };
  appendBot(sessionId, getNodeText(sessions[sessionId].currentNode));
  updateVisualizer();
}

// -----------------------------
// Event listeners
// -----------------------------
sendButton.addEventListener("click", () => {
  const message = userInput.value.trim();
  if(!message) return;
  appendUser(sessionId, message);
  handleMessage(sessionId, message);
  userInput.value="";
});

userInput.addEventListener("keypress", (e)=>{
  if(e.key==="Enter") sendButton.click();
});

// -----------------------------
// Funciones de interacción
// -----------------------------
function appendUser(sid, text){
  sessions[sid].messages.push({from:"user", text});
  const div = document.createElement("div"); div.className="message user"; div.textContent=text;
  messagesEl.appendChild(div);
  messagesEl.scrollTop = messagesEl.scrollHeight;
  updateVisualizer();
}

function appendBot(sid, text){
  sessions[sid].messages.push({from:"bot", text});
  if(!text) return;
  const div = document.createElement("div"); div.className="message bot"; div.textContent=text;
  messagesEl.appendChild(div);
  messagesEl.scrollTop = messagesEl.scrollHeight;
  updateVisualizer();
}

function handleMessage(sid, message){
  let session = sessions[sid];
  let node = session.currentNode;

  if(node.type==="trigger"){
    if(node.triggers.includes(message.toLowerCase())){
      session.currentNode = json.nodes.find(n=>n.id===node.next);
      appendBot(sid, getNodeText(session.currentNode, session.userData));
    } else {
      appendBot(sid, `Escribe uno de los siguientes triggers: ${node.triggers.join(", ")}`);
    }
    updateVisualizer();
    return;
  }

  if(node.type==="question"){
    if(node.key) session.userData[node.key] = message; // guardar respuesta
    let nextNode = json.nodes.find(n=>n.id===node.next);
    if(nextNode.type==="flow") nextNode = nextNode.nodesInFlow[0]; // entrar al flow
    appendBot(sid, getNodeText(nextNode, session.userData));
    session.currentNode = nextNode;
    updateVisualizer();
    return;
  }

  if(node.type==="decision"){
    const selected = node.options.find(o=>o.label.toLowerCase()===message.toLowerCase());
    if(selected){
      let nextNode = json.nodes.find(n=>n.id===selected.next);
      if(nextNode.type==="flow") nextNode = nextNode.nodesInFlow[0];
      appendBot(sid, getNodeText(nextNode, session.userData));
      session.currentNode = nextNode;
    } else {
      appendBot(sid, `Opciones: ${node.options.map(o=>o.label).join(", ")}`);
    }
    updateVisualizer();
    return;
  }

  if(node.type==="response"){
    // construir resumen final usando userData
    let text = node.text.replace(/\{\{(.*?)\}\}/g, (_, key)=>{
      const keys = key.split("||").map(k=>k.trim());
      for(let k of keys){
        if(session.userData[k]) return session.userData[k];
      }
      return "";
    });
    appendBot(sid, text);
    session.currentNode = null; // fin de la conversación
    updateVisualizer();
  }
}

// -----------------------------
// Obtener texto de nodo
// -----------------------------
function getNodeText(node, userData={}){
  if(!node) return "";
  if(node.type==="question"){
    return node.options.length>0 ? `${node.text}\nOpciones: ${node.options.join(", ")}` : node.text;
  }
  if(node.type==="decision"){
    return `${node.text}\nOpciones: ${node.options.map(o=>o.label).join(", ")}`;
  }
  if(node.type==="response"){
    return node.text.replace(/\{\{(.*?)\}\}/g, (_, key)=>{
      const keys = key.split("||").map(k=>k.trim());
      for(let k of keys){
        if(userData[k]) return userData[k];
      }
      return "";
    });
  }
  if(node.type==="trigger"){
    return `¡Hola! Escribe uno de los siguientes triggers: ${node.triggers.join(", ")}`;
  }
  return node.text || "";
}

// -----------------------------
// Visualizador JSON en tiempo real
// -----------------------------
function updateVisualizer(){
  jsonView.textContent = JSON.stringify(sessions[sessionId], null, 2);
}
</script>

</body>
</html>
