<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Flow Editor Final</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; }
.flow-box, .subflow-box {
  border: 2px solid #333; border-radius: 8px; padding: 10px;
  margin: 10px; cursor: pointer; display: inline-block;
  min-width: 150px; vertical-align: top; background: #f9f9f9;
}
.flow-box:hover, .subflow-box:hover { background: #e9e9e9; }
.editor { border: 2px solid #666; padding: 10px; margin-top: 20px; border-radius: 8px; }
.step { border: 1px dashed #666; margin: 10px 0; padding: 8px; border-radius: 6px; }
.inline-inputs input, .inline-inputs select, .inline-inputs textarea { margin-right: 6px; }
button { margin-top: 5px; }
.red { color: red; }
</style>
</head>
<body>

<h2>Flow Editor Final</h2>

<div>
  <input id="flowName" placeholder="Nombre del flow">
  <input id="flowId" placeholder="ID (ej: 1001)">
  <select id="flowType">
    <option value="main">main</option>
    <option value="subflow">subflow</option>
  </select>
  <input id="flowTriggers" placeholder="Triggers (solo main)">
  <button id="createFlowBtn">‚ûï Crear Flow</button>
</div>

<h3>Flows y Subflows</h3>
<div id="flowsContainer"></div>

<h3>Editor</h3>
<div id="editor" class="editor">Selecciona un flow o subflow para editar...</div>

<h3>JSON Generado</h3>
<pre id="output"></pre>

<script>
class FlowEditorFinal {
  constructor(flowsContainerId, editorId, outputId){
    this.data = {};
    this.flowsContainer = document.getElementById(flowsContainerId);
    this.editorContainer = document.getElementById(editorId);
    this.output = document.getElementById(outputId);
    this.currentEditing = null;

    document.getElementById("flowType").addEventListener("change", function() {
      document.getElementById("flowTriggers").style.display = this.value==="main"?"inline-block":"none";
    });

    document.getElementById("createFlowBtn").addEventListener("click", ()=>this.createFlow());
  }

  createFlow(){
    let name = document.getElementById("flowName").value.trim();
    let id = parseInt(document.getElementById("flowId").value.trim());
    let type = document.getElementById("flowType").value.trim();
    let triggers = document.getElementById("flowTriggers").value.trim();

    if(!name || isNaN(id)){ alert("Debes ingresar nombre e ID num√©rico"); return; }

    this.data[name] = {
      type,
      id,
      ...(type==="main" && triggers? {triggers: triggers.split(",").map(t=>t.trim())}: {}),
      steps: []
    };

    document.getElementById("flowName").value="";
    document.getElementById("flowId").value="";
    document.getElementById("flowTriggers").value="";

    this.renderFlows();
    this.renderJSON();
  }

  renderFlows(){
    this.flowsContainer.innerHTML="";
    for(let [name, flow] of Object.entries(this.data)){
      let div=document.createElement("div");
      div.className = flow.type==="main"?"flow-box":"subflow-box";
      div.innerText=`${name} (${flow.type})\nID: ${flow.id}`;
      div.addEventListener("click", ()=>this.editFlow(name));
      this.flowsContainer.appendChild(div);
    }
  }

  editFlow(name){
    this.currentEditing = name;
    let flow = this.data[name];
    this.editorContainer.innerHTML=`<h3>Editar ${name} (${flow.type})</h3>
      ID: <input value="${flow.id}" onchange="editor.data['${name}'].id=parseInt(this.value)||0; editor.renderJSON()"><br>
      ${flow.type==="main"?`Triggers: <input value="${flow.triggers?flow.triggers.join(','):""}" onchange="editor.data['${name}'].triggers=this.value.split(',').map(t=>t.trim()); editor.renderJSON()"><br>`:""}
      <button onclick="editor.addStep('${name}')">‚ûï Step</button><hr>`;

    flow.steps.forEach((s,i)=>{ this.renderStep(name, s, i); });

    this.renderJSON();
  }

  renderStep(flowName, step, index){
    let stepDiv = document.createElement("div");
    stepDiv.className="step";
    stepDiv.innerHTML=`<b>Step ${step.step}</b><br>
      Tipo: 
      <select onchange="editor.changeStepType('${flowName}', ${index}, this.value)">
        <option value="question" ${step.type==="question"?"selected":""}>Pregunta</option>
        <option value="options" ${step.type==="options"?"selected":""}>Options</option>
        <option value="subflow" ${step.type==="subflow"?"selected":""}>Subflow</option>
      </select><br>
      Pregunta: <textarea onchange="editor.data['${flowName}'].steps[${index}].question=this.value; editor.renderJSON()">${step.question}</textarea><br>
      Key: <input value="${step.key||""}" onchange="editor.data['${flowName}'].steps[${index}].key=this.value||null; editor.renderJSON()"><br>
    `;

    // Si tipo options
    if(step.type==="options"){
      if(step.options && Object.keys(step.options).length){
        let ul = document.createElement("ul");
        for(let [opt, vals] of Object.entries(step.options)){
          let li = document.createElement("li");
          li.innerHTML = `"${opt}" : [${vals.map(v=>'"'+v+'"').join(", ")}] 
            <button onclick="editor.deleteOption('${flowName}', ${index}, '${opt}')">üóëÔ∏è</button>`;
          ul.appendChild(li);
        }
        stepDiv.appendChild(ul);
      }

      let optName=`optName-${flowName}-${index}`;
      let optValues=`optValues-${flowName}-${index}`;
      stepDiv.innerHTML += `<div class="inline-inputs">
        <input id="${optName}" placeholder="Nombre opci√≥n">
        <input id="${optValues}" placeholder="Valores (ej: 1,latte)">
        <button onclick="editor.saveOption('${flowName}',${index},document.getElementById('${optName}').value,document.getElementById('${optValues}').value)">‚ûï Opci√≥n</button>
      </div>`;
    }

    // Si tipo subflow
    if(step.type==="subflow"){
      if(step.subflows && Object.keys(step.subflows).length){
        let ul = document.createElement("ul");
        for(let [subId, vals] of Object.entries(step.subflows)){
          let li = document.createElement("li");
          li.innerHTML = `"${subId}" : [${vals.map(v=>'"'+v+'"').join(", ")}] 
            <button onclick="editor.deleteSubflow('${flowName}', ${index}, '${subId}')">üóëÔ∏è</button>`;
          ul.appendChild(li);
        }
        stepDiv.appendChild(ul);
      }

      let availableSubflows = Object.values(this.data).filter(f=>f.type==="subflow");
      if(!availableSubflows.length){
        stepDiv.innerHTML += `<div class="red">‚ö†Ô∏è No hay subflows creados.</div>`;
      } else {
        // ‚ö†Ô∏è Filtrar los ya agregados en este step
        let selectable = availableSubflows.filter(f => !(step.subflows && step.subflows[f.id]));
        if(selectable.length){
          let subIdInput = `subId-${flowName}-${index}`;
          let subValInput = `subVal-${flowName}-${index}`;
          let options = selectable.map(f => `<option value="${f.id}">${f.id}</option>`).join("");
          stepDiv.innerHTML += `<div class="inline-inputs">
            <select id="${subIdInput}">${options}</select>
            <input id="${subValInput}" placeholder="Valores (ej: 1,cafe)">
            <button onclick="editor.saveSubflow('${flowName}',${index},document.getElementById('${subIdInput}').value,document.getElementById('${subValInput}').value)">‚ûï Subflow</button>
          </div>`;
        } else {
          stepDiv.innerHTML += `<div class="red">‚úÖ Todos los subflows disponibles ya fueron agregados en este paso.</div>`;
        }
      }
    }

    stepDiv.innerHTML += `<button onclick="editor.deleteStep('${flowName}',${index})">üóëÔ∏è Eliminar Step</button>`;
    this.editorContainer.appendChild(stepDiv);
  }

  changeStepType(flowName, index, newType){
    let step = this.data[flowName].steps[index];
    step.type = newType;
    if(newType==="options"){ delete step.subflows; step.options=step.options||{}; }
    else if(newType==="subflow"){ delete step.options; step.subflows=step.subflows||{}; }
    else { delete step.options; delete step.subflows; }
    this.editFlow(flowName);
  }

  addStep(flowName){
    let flow = this.data[flowName];
    flow.steps.push({
      step: flow.steps.length+1,
      type: "question",
      question: "Nueva pregunta...",
      key: null
    });
    this.editFlow(flowName);
  }

  saveOption(flowName, stepIndex, optName, optValues){
    if(!optName || !optValues) return;
    let step = this.data[flowName].steps[stepIndex];
    if(!step.options) step.options={};
    step.options[optName]=optValues.split(",").map(v=>v.trim());
    this.editFlow(flowName);
  }

  deleteOption(flowName, stepIndex, optName){
    delete this.data[flowName].steps[stepIndex].options[optName];
    this.editFlow(flowName);
  }

  saveSubflow(flowName, stepIndex, subId, values){
    let exists = Object.values(this.data).some(f=>f.type==="subflow" && f.id==subId);
    if(!exists){ alert("‚ö†Ô∏è No existe el subflow con id "+subId); return; }
    let step=this.data[flowName].steps[stepIndex];
    if(!step.subflows) step.subflows={};
    step.subflows[subId]=values.split(",").map(v=>v.trim());
    this.editFlow(flowName);
  }

  deleteSubflow(flowName, stepIndex, subId){
    delete this.data[flowName].steps[stepIndex].subflows[subId];
    this.editFlow(flowName);
  }

  deleteStep(flowName, stepIndex){
    let flow=this.data[flowName];
    flow.steps.splice(stepIndex,1);
    flow.steps.forEach((s,i)=>s.step=i+1);
    this.editFlow(flowName);
  }

  renderJSON(){
    // Serializaci√≥n: id como n√∫mero, key vac√≠o como null
    let cleanData = JSON.parse(JSON.stringify(this.data, (key, value)=>{
      if(key==="id") return Number(value);
      if(key==="key" && (value==="" || value===undefined)) return null;
      return value;
    }, 2));
    this.output.textContent=JSON.stringify(cleanData,null,2);
    this.renderFlows();
  }
}

const editor = new FlowEditorFinal("flowsContainer","editor","output");
</script>

</body>
</html>
