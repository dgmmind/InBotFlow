<!-- <!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Flow Editor Final</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; }
.flow-box, .subflow-box {
  border: 2px solid #333; border-radius: 8px; padding: 10px;
  margin: 10px; cursor: pointer; display: inline-block;
  min-width: 150px; vertical-align: top; background: #f9f9f9;
}
.flow-box:hover, .subflow-box:hover { background: #e9e9e9; }
.editor { border: 2px solid #666; padding: 10px; margin-top: 20px; border-radius: 8px; }
.step { border: 1px dashed #666; margin: 10px 0; padding: 8px; border-radius: 6px; }
.inline-inputs input, .inline-inputs select, .inline-inputs textarea { margin-right: 6px; }
button { margin-top: 5px; }
.red { color: red; }
</style>
</head>
<body>

<h2>Flow Editor Final</h2>

<div>
  <input id="flowName" placeholder="Nombre del flow">
  <input id="flowId" placeholder="ID (ej: 1001)">
  <select id="flowType">
    <option value="main">main</option>
    <option value="subflow">subflow</option>
  </select>
  <input id="flowTriggers" placeholder="Triggers (solo main)">
  <button id="createFlowBtn">‚ûï Crear Flow</button>
</div>

<h3>Flows y Subflows</h3>
<div id="flowsContainer"></div>

<h3>Editor</h3>
<div id="editor" class="editor">Selecciona un flow o subflow para editar...</div>

<h3>JSON Generado</h3>
<pre id="output"></pre>

<script>
class FlowEditorFinal {
  constructor(flowsContainerId, editorId, outputId){
    this.data = {};
    this.flowsContainer = document.getElementById(flowsContainerId);
    this.editorContainer = document.getElementById(editorId);
    this.output = document.getElementById(outputId);
    this.currentEditing = null;

    document.getElementById("flowType").addEventListener("change", function() {
      document.getElementById("flowTriggers").style.display = this.value==="main"?"inline-block":"none";
    });

    document.getElementById("createFlowBtn").addEventListener("click", ()=>this.createFlow());
  }

  createFlow(){
    let name = document.getElementById("flowName").value.trim();
    let id = parseInt(document.getElementById("flowId").value.trim());
    let type = document.getElementById("flowType").value.trim();
    let triggers = document.getElementById("flowTriggers").value.trim();

    if(!name || isNaN(id)){ alert("Debes ingresar nombre e ID num√©rico"); return; }

    this.data[name] = {
      type,
      id,
      ...(type==="main" && triggers? {triggers: triggers.split(",").map(t=>t.trim())}: {}),
      steps: []
    };

    document.getElementById("flowName").value="";
    document.getElementById("flowId").value="";
    document.getElementById("flowTriggers").value="";

    this.renderFlows();
    this.renderJSON();
  }

  renderFlows(){
    this.flowsContainer.innerHTML="";
    for(let [name, flow] of Object.entries(this.data)){
      let div=document.createElement("div");
      div.className = flow.type==="main"?"flow-box":"subflow-box";
      div.innerText=`${name} (${flow.type})\nID: ${flow.id}`;
      div.addEventListener("click", ()=>this.editFlow(name));
      this.flowsContainer.appendChild(div);
    }
  }

  editFlow(name){
    this.currentEditing = name;
    let flow = this.data[name];
    this.editorContainer.innerHTML=`<h3>Editar ${name} (${flow.type})</h3>
      ID: <input value="${flow.id}" onchange="editor.data['${name}'].id=parseInt(this.value)||0; editor.renderJSON()"><br>
      ${flow.type==="main"?`Triggers: <input value="${flow.triggers?flow.triggers.join(','):""}" onchange="editor.data['${name}'].triggers=this.value.split(',').map(t=>t.trim()); editor.renderJSON()"><br>`:""}
      <button onclick="editor.addStep('${name}')">‚ûï Step</button><hr>`;

    flow.steps.forEach((s,i)=>{ this.renderStep(name, s, i); });

    this.renderJSON();
  }

  renderStep(flowName, step, index){
    let stepDiv = document.createElement("div");
    stepDiv.className="step";
    stepDiv.innerHTML=`<b>Step ${step.step}</b><br>
      Tipo: 
      <select onchange="editor.changeStepType('${flowName}', ${index}, this.value)">
        <option value="question" ${step.type==="question"?"selected":""}>Pregunta</option>
        <option value="options" ${step.type==="options"?"selected":""}>Options</option>
        <option value="subflow" ${step.type==="subflow"?"selected":""}>Subflow</option>
      </select><br>
      Pregunta: <textarea onchange="editor.data['${flowName}'].steps[${index}].question=this.value; editor.renderJSON()">${step.question}</textarea><br>
      Key: <input value="${step.key||""}" onchange="editor.data['${flowName}'].steps[${index}].key=this.value||null; editor.renderJSON()"><br>
    `;

    // Si tipo options
    if(step.type==="options"){
      if(step.options && Object.keys(step.options).length){
        let ul = document.createElement("ul");
        for(let [opt, vals] of Object.entries(step.options)){
          let li = document.createElement("li");
          li.innerHTML = `"${opt}" : [${vals.map(v=>'"'+v+'"').join(", ")}] 
            <button onclick="editor.deleteOption('${flowName}', ${index}, '${opt}')">üóëÔ∏è</button>`;
          ul.appendChild(li);
        }
        stepDiv.appendChild(ul);
      }

      let optName=`optName-${flowName}-${index}`;
      let optValues=`optValues-${flowName}-${index}`;
      stepDiv.innerHTML += `<div class="inline-inputs">
        <input id="${optName}" placeholder="Nombre opci√≥n">
        <input id="${optValues}" placeholder="Valores (ej: 1,latte)">
        <button onclick="editor.saveOption('${flowName}',${index},document.getElementById('${optName}').value,document.getElementById('${optValues}').value)">‚ûï Opci√≥n</button>
      </div>`;
    }

    // Si tipo subflow
    if(step.type==="subflow"){
      if(step.subflows && Object.keys(step.subflows).length){
        let ul = document.createElement("ul");
        for(let [subId, vals] of Object.entries(step.subflows)){
          let li = document.createElement("li");
          li.innerHTML = `"${subId}" : [${vals.map(v=>'"'+v+'"').join(", ")}] 
            <button onclick="editor.deleteSubflow('${flowName}', ${index}, '${subId}')">üóëÔ∏è</button>`;
          ul.appendChild(li);
        }
        stepDiv.appendChild(ul);
      }

      let availableSubflows = Object.values(this.data).filter(f=>f.type==="subflow");
      if(!availableSubflows.length){
        stepDiv.innerHTML += `<div class="red">‚ö†Ô∏è No hay subflows creados.</div>`;
      } else {
        // ‚ö†Ô∏è Filtrar los ya agregados en este step
        let selectable = availableSubflows.filter(f => !(step.subflows && step.subflows[f.id]));
        if(selectable.length){
          let subIdInput = `subId-${flowName}-${index}`;
          let subValInput = `subVal-${flowName}-${index}`;
          let options = selectable.map(f => `<option value="${f.id}">${f.id}</option>`).join("");
          stepDiv.innerHTML += `<div class="inline-inputs">
            <select id="${subIdInput}">${options}</select>
            <input id="${subValInput}" placeholder="Valores (ej: 1,cafe)">
            <button onclick="editor.saveSubflow('${flowName}',${index},document.getElementById('${subIdInput}').value,document.getElementById('${subValInput}').value)">‚ûï Subflow</button>
          </div>`;
        } else {
          stepDiv.innerHTML += `<div class="red">‚úÖ Todos los subflows disponibles ya fueron agregados en este paso.</div>`;
        }
      }
    }

    stepDiv.innerHTML += `<button onclick="editor.deleteStep('${flowName}',${index})">üóëÔ∏è Eliminar Step</button>`;
    this.editorContainer.appendChild(stepDiv);
  }

  changeStepType(flowName, index, newType){
    let step = this.data[flowName].steps[index];
    step.type = newType;
    if(newType==="options"){ delete step.subflows; step.options=step.options||{}; }
    else if(newType==="subflow"){ delete step.options; step.subflows=step.subflows||{}; }
    else { delete step.options; delete step.subflows; }
    this.editFlow(flowName);
  }

  addStep(flowName){
    let flow = this.data[flowName];
    flow.steps.push({
      step: flow.steps.length+1,
      type: "question",
      question: "Nueva pregunta...",
      key: null
    });
    this.editFlow(flowName);
  }

  saveOption(flowName, stepIndex, optName, optValues){
    if(!optName || !optValues) return;
    let step = this.data[flowName].steps[stepIndex];
    if(!step.options) step.options={};
    step.options[optName]=optValues.split(",").map(v=>v.trim());
    this.editFlow(flowName);
  }

  deleteOption(flowName, stepIndex, optName){
    delete this.data[flowName].steps[stepIndex].options[optName];
    this.editFlow(flowName);
  }

  saveSubflow(flowName, stepIndex, subId, values){
    let exists = Object.values(this.data).some(f=>f.type==="subflow" && f.id==subId);
    if(!exists){ alert("‚ö†Ô∏è No existe el subflow con id "+subId); return; }
    let step=this.data[flowName].steps[stepIndex];
    if(!step.subflows) step.subflows={};
    step.subflows[subId]=values.split(",").map(v=>v.trim());
    this.editFlow(flowName);
  }

  deleteSubflow(flowName, stepIndex, subId){
    delete this.data[flowName].steps[stepIndex].subflows[subId];
    this.editFlow(flowName);
  }

  deleteStep(flowName, stepIndex){
    let flow=this.data[flowName];
    flow.steps.splice(stepIndex,1);
    flow.steps.forEach((s,i)=>s.step=i+1);
    this.editFlow(flowName);
  }

  renderJSON(){
    // Serializaci√≥n: id como n√∫mero, key vac√≠o como null
    let cleanData = JSON.parse(JSON.stringify(this.data, (key, value)=>{
      if(key==="id") return Number(value);
      if(key==="key" && (value==="" || value===undefined)) return null;
      return value;
    }, 2));
    this.output.textContent=JSON.stringify(cleanData,null,2);
    this.renderFlows();
  }
}

const editor = new FlowEditorFinal("flowsContainer","editor","output");
</script>

</body>
</html> -->
<!-- <!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Flow Editor Mejorado</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; }
.flow-box, .subflow-box {
  border: 2px solid #333; border-radius: 8px; padding: 10px;
  margin: 10px; cursor: pointer; display: inline-block;
  min-width: 150px; vertical-align: top; background: #f9f9f9;
}
.flow-box:hover, .subflow-box:hover { background: #e9e9e9; }
.editor { border: 2px solid #666; padding: 10px; margin-top: 20px; border-radius: 8px; }
.step { border: 1px dashed #666; margin: 10px 0; padding: 8px; border-radius: 6px; cursor: grab; }
.inline-inputs input, .inline-inputs select, .inline-inputs textarea { margin-right: 6px; }
button { margin-top: 5px; }
.red { color: red; }
#toolbar { margin-bottom: 15px; }
</style>
</head>
<body>

<h2>Flow Editor Mejorado</h2>

<div id="toolbar">
  <input id="flowName" placeholder="Nombre del flow">
  <input id="flowId" placeholder="ID (ej: 1001)">
  <select id="flowType">
    <option value="main">main</option>
    <option value="subflow">subflow</option>
  </select>
  <input id="flowTriggers" placeholder="Triggers (solo main)">
  <button id="createFlowBtn">‚ûï Crear Flow</button>
  <button id="exportJSONBtn">üíæ Exportar JSON</button>
  <button id="importJSONBtn">üìÇ Importar JSON</button>
</div>

<h3>Flows y Subflows</h3>
<div id="flowsContainer"></div>

<h3>Editor</h3>
<div id="editor" class="editor">Selecciona un flow o subflow para editar...</div>

<h3>JSON Generado</h3>
<pre id="output"></pre>

<input type="file" id="fileInput" style="display:none">

<script>
class FlowEditor {
  constructor(flowsContainerId, editorId, outputId){
    this.data = JSON.parse(localStorage.getItem("flowsData") || "{}");
    this.flowsContainer = document.getElementById(flowsContainerId);
    this.editorContainer = document.getElementById(editorId);
    this.output = document.getElementById(outputId);
    this.currentEditing = null;

    document.getElementById("flowType").addEventListener("change", function() {
      document.getElementById("flowTriggers").style.display = this.value==="main"?"inline-block":"none";
    });

    document.getElementById("createFlowBtn").addEventListener("click", ()=>this.createFlow());
    document.getElementById("exportJSONBtn").addEventListener("click", ()=>this.exportJSON());
    document.getElementById("importJSONBtn").addEventListener("click", ()=>this.importJSON());
    document.getElementById("fileInput").addEventListener("change", e=>this.handleFile(e));

    this.renderFlows();
    this.renderJSON();
  }

  saveData(){
    localStorage.setItem("flowsData", JSON.stringify(this.data));
  }

  createFlow(){
    let name = document.getElementById("flowName").value.trim();
    let id = parseInt(document.getElementById("flowId").value.trim());
    let type = document.getElementById("flowType").value.trim();
    let triggers = document.getElementById("flowTriggers").value.trim();

    if(!name || isNaN(id)){ alert("Debes ingresar nombre e ID num√©rico"); return; }
    if(Object.values(this.data).some(f=>f.id===id)){ alert("ID duplicado"); return; }

    this.data[name] = {
      type,
      id,
      ...(type==="main" && triggers? {triggers: triggers.split(",").map(t=>t.trim())}: {}),
      steps: []
    };

    document.getElementById("flowName").value="";
    document.getElementById("flowId").value="";
    document.getElementById("flowTriggers").value="";

    this.renderFlows();
    this.renderJSON();
    this.saveData();
  }

  renderFlows(){
    this.flowsContainer.innerHTML="";
    for(let [name, flow] of Object.entries(this.data)){
      let div=document.createElement("div");
      div.className = flow.type==="main"?"flow-box":"subflow-box";
      div.innerText=`${name} (${flow.type})\nID: ${flow.id}`;
      div.addEventListener("click", ()=>this.editFlow(name));
      this.flowsContainer.appendChild(div);
    }
  }

  editFlow(name){
    this.currentEditing = name;
    let flow = this.data[name];
    this.editorContainer.innerHTML=`<h3>Editar ${name} (${flow.type})</h3>
      ID: <input value="${flow.id}" onchange="editor.data['${name}'].id=parseInt(this.value)||0; editor.renderJSON(); editor.saveData()"><br>
      ${flow.type==="main"?`Triggers: <input value="${flow.triggers?flow.triggers.join(','):""}" onchange="editor.data['${name}'].triggers=this.value.split(',').map(t=>t.trim()); editor.renderJSON(); editor.saveData()"><br>`:""}
      <button onclick="editor.addStep('${name}')">‚ûï Step</button><hr>`;

    flow.steps.forEach((s,i)=>{ this.renderStep(name, s, i); });
    this.renderJSON();
  }

  renderStep(flowName, step, index){
    let stepDiv = document.createElement("div");
    stepDiv.className="step";
    stepDiv.draggable=true;

    stepDiv.addEventListener("dragstart", e=>{
      e.dataTransfer.setData("text/plain", index);
    });
    stepDiv.addEventListener("dragover", e=>e.preventDefault());
    stepDiv.addEventListener("drop", e=>{
      e.preventDefault();
      let draggedIndex = parseInt(e.dataTransfer.getData("text/plain"));
      let steps = this.data[flowName].steps;
      let temp = steps[draggedIndex];
      steps.splice(draggedIndex,1);
      steps.splice(index,0,temp);
      steps.forEach((s,i)=>s.step=i+1);
      this.editFlow(flowName);
      this.saveData();
    });

    stepDiv.innerHTML=`<b>Step ${step.step}</b><br>
      Tipo: 
      <select onchange="editor.changeStepType('${flowName}', ${index}, this.value)">
        <option value="question" ${step.type==="question"?"selected":""}>Pregunta</option>
        <option value="options" ${step.type==="options"?"selected":""}>Options</option>
        <option value="subflow" ${step.type==="subflow"?"selected":""}>Subflow</option>
      </select><br>
      Pregunta: <textarea onchange="editor.data['${flowName}'].steps[${index}].question=this.value; editor.renderJSON(); editor.saveData()">${step.question}</textarea><br>
      Key: <input value="${step.key||""}" onchange="editor.data['${flowName}'].steps[${index}].key=this.value||null; editor.renderJSON(); editor.saveData()"><br>`;

    if(step.type==="options"){
      if(step.options && Object.keys(step.options).length){
        let ul = document.createElement("ul");
        for(let [opt, vals] of Object.entries(step.options)){
          let li = document.createElement("li");
          li.innerHTML = `"${opt}" : [${vals.map(v=>'"'+v+'"').join(", ")}] 
            <button onclick="editor.deleteOption('${flowName}', ${index}, '${opt}')">üóëÔ∏è</button>`;
          ul.appendChild(li);
        }
        stepDiv.appendChild(ul);
      }
      let optName=`optName-${flowName}-${index}`;
      let optValues=`optValues-${flowName}-${index}`;
      stepDiv.innerHTML += `<div class="inline-inputs">
        <input id="${optName}" placeholder="Nombre opci√≥n">
        <input id="${optValues}" placeholder="Valores (ej: 1,latte)">
        <button onclick="editor.saveOption('${flowName}',${index},document.getElementById('${optName}').value,document.getElementById('${optValues}').value)">‚ûï Opci√≥n</button>
      </div>`;
    }

    if(step.type==="subflow"){
      let availableSubflows = Object.values(this.data).filter(f=>f.type==="subflow");
      if(!availableSubflows.length){
        stepDiv.innerHTML += `<div class="red">‚ö†Ô∏è No hay subflows creados.</div>`;
      } else {
        let selectable = availableSubflows.filter(f => !(step.subflows && step.subflows[f.id]));
        if(selectable.length){
          let subIdInput = `subId-${flowName}-${index}`;
          let subValInput = `subVal-${flowName}-${index}`;
          let options = selectable.map(f=>`<option value="${f.id}">${f.id}</option>`).join("");
          stepDiv.innerHTML += `<div class="inline-inputs">
            <select id="${subIdInput}">${options}</select>
            <input id="${subValInput}" placeholder="Valores (ej: 1,cafe)">
            <button onclick="editor.saveSubflow('${flowName}',${index},document.getElementById('${subIdInput}').value,document.getElementById('${subValInput}').value)">‚ûï Subflow</button>
          </div>`;
        } else stepDiv.innerHTML += `<div class="red">‚úÖ Todos los subflows ya agregados.</div>`;
      }
    }

    stepDiv.innerHTML += `<button onclick="editor.deleteStep('${flowName}',${index})">üóëÔ∏è Eliminar Step</button>`;
    this.editorContainer.appendChild(stepDiv);
  }

  changeStepType(flowName, index, newType){
    let step = this.data[flowName].steps[index];
    step.type=newType;
    if(newType==="options"){ delete step.subflows; step.options=step.options||{}; }
    else if(newType==="subflow"){ delete step.options; step.subflows=step.subflows||{}; }
    else { delete step.options; delete step.subflows; }
    this.editFlow(flowName);
    this.saveData();
  }

  addStep(flowName){
    let flow=this.data[flowName];
    flow.steps.push({step: flow.steps.length+1, type:"question", question:"Nueva pregunta...", key:null});
    this.editFlow(flowName);
    this.saveData();
  }

  saveOption(flowName, stepIndex, optName, optValues){
    if(!optName || !optValues) return;
    let step=this.data[flowName].steps[stepIndex];
    if(!step.options) step.options={};
    step.options[optName]=optValues.split(",").map(v=>v.trim());
    this.editFlow(flowName);
    this.saveData();
  }

  deleteOption(flowName, stepIndex, optName){
    delete this.data[flowName].steps[stepIndex].options[optName];
    this.editFlow(flowName);
    this.saveData();
  }

  saveSubflow(flowName, stepIndex, subId, values){
    let exists = Object.values(this.data).some(f=>f.type==="subflow" && f.id==subId);
    if(!exists){ alert("‚ö†Ô∏è No existe subflow con id "+subId); return; }
    let step=this.data[flowName].steps[stepIndex];
    if(!step.subflows) step.subflows={};
    step.subflows[subId]=values.split(",").map(v=>v.trim());
    this.editFlow(flowName);
    this.saveData();
  }

  deleteSubflow(flowName, stepIndex, subId){
    delete this.data[flowName].steps[stepIndex].subflows[subId];
    this.editFlow(flowName);
    this.saveData();
  }

  deleteStep(flowName, stepIndex){
    let flow=this.data[flowName];
    flow.steps.splice(stepIndex,1);
    flow.steps.forEach((s,i)=>s.step=i+1);
    this.editFlow(flowName);
    this.saveData();
  }

  renderJSON(){
    let cleanData = JSON.parse(JSON.stringify(this.data, (key,value)=>{
      if(key==="id") return Number(value);
      if(key==="key" && (value==="" || value===undefined)) return null;
      return value;
    },2));
    this.output.textContent=JSON.stringify(cleanData,null,2);
    this.renderFlows();
  }

  exportJSON(){
    const blob = new Blob([JSON.stringify(this.data,null,2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url;
    a.download="flows.json";
    a.click();
    URL.revokeObjectURL(url);
  }

  importJSON(){
    document.getElementById("fileInput").click();
  }

  handleFile(e){
    const file=e.target.files[0];
    if(!file) return;
    const reader=new FileReader();
    reader.onload=()=> {
      try{
        this.data=JSON.parse(reader.result);
        this.renderFlows();
        this.renderJSON();
        this.saveData();
        alert("‚úÖ JSON importado correctamente");
      } catch(err){ alert("‚ùå Error al importar JSON"); }
    };
    reader.readAsText(file);
  }
}

const editor = new FlowEditor("flowsContainer","editor","output");
</script>

</body>
</html> -->

<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Flow Editor Minimalista</title>
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: #f8fafc;
  color: #334155;
  line-height: 1.6;
}

.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 2rem;
}

.header {
  text-align: center;
  margin-bottom: 3rem;
}

.header h1 {
  font-size: 2.5rem;
  font-weight: 300;
  color: #1e293b;
  margin-bottom: 0.5rem;
}

.header p {
  color: #64748b;
  font-size: 1.1rem;
}

.toolbar {
  background: white;
  padding: 1.5rem;
  border-radius: 12px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  margin-bottom: 2rem;
  display: flex;
  gap: 1rem;
  flex-wrap: wrap;
  align-items: center;
}

.toolbar input, .toolbar select {
  padding: 0.75rem 1rem;
  border: 1px solid #e2e8f0;
  border-radius: 8px;
  font-size: 0.9rem;
  transition: border-color 0.2s;
  min-width: 150px;
}

.toolbar input:focus, .toolbar select:focus {
  outline: none;
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.btn {
  padding: 0.75rem 1.5rem;
  border: none;
  border-radius: 8px;
  font-size: 0.9rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
}

.btn-primary {
  background: #3b82f6;
  color: white;
}

.btn-primary:hover {
  background: #2563eb;
  transform: translateY(-1px);
}

.btn-secondary {
  background: #f1f5f9;
  color: #475569;
}

.btn-secondary:hover {
  background: #e2e8f0;
}

.flows-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 1.5rem;
  margin-bottom: 2rem;
}

.flow-card {
  background: white;
  border-radius: 12px;
  padding: 1.5rem;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  cursor: pointer;
  transition: all 0.2s;
  border: 2px solid transparent;
  position: relative;
  overflow: hidden;
}

.flow-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.flow-card.main {
  border-left: 4px solid #10b981;
}

.flow-card.subflow {
  border-left: 4px solid #f59e0b;
}

.flow-card::before {
  content: '';
  position: absolute;
  top: 0;
  right: 0;
  width: 60px;
  height: 60px;
  background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(59, 130, 246, 0.05));
  border-radius: 0 12px 0 60px;
}

.flow-title {
  font-size: 1.25rem;
  font-weight: 600;
  margin-bottom: 0.5rem;
  color: #1e293b;
}

.flow-meta {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
}

.flow-type {
  padding: 0.25rem 0.75rem;
  border-radius: 20px;
  font-size: 0.75rem;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.flow-type.main {
  background: #dcfce7;
  color: #166534;
}

.flow-type.subflow {
  background: #fef3c7;
  color: #92400e;
}

.flow-id {
  font-family: 'Courier New', monospace;
  font-size: 0.9rem;
  color: #64748b;
}

.flow-steps {
  color: #64748b;
  font-size: 0.9rem;
}

.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(4px);
  z-index: 1000;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s ease;
}

.modal-overlay.active {
  opacity: 1;
  visibility: visible;
}

.modal {
  position: fixed;
  top: 0;
  right: 0;
  width: 500px;
  height: 100vh;
  background: white;
  box-shadow: -4px 0 20px rgba(0, 0, 0, 0.15);
  transform: translateX(100%);
  transition: transform 0.3s ease;
  overflow-y: auto;
  z-index: 1001;
}

.modal.active {
  transform: translateX(0);
}

.modal-header {
  padding: 2rem;
  border-bottom: 1px solid #e2e8f0;
  background: #f8fafc;
}

.modal-title {
  font-size: 1.5rem;
  font-weight: 600;
  color: #1e293b;
  margin-bottom: 0.5rem;
}

.modal-subtitle {
  color: #64748b;
  font-size: 0.9rem;
}

.modal-content {
  padding: 2rem;
}

.form-group {
  margin-bottom: 1.5rem;
}

.form-label {
  display: block;
  margin-bottom: 0.5rem;
  font-weight: 500;
  color: #374151;
}

.form-input, .form-select, .form-textarea {
  width: 100%;
  padding: 0.75rem;
  border: 1px solid #e2e8f0;
  border-radius: 8px;
  font-size: 0.9rem;
  transition: border-color 0.2s;
}

.form-input:focus, .form-select:focus, .form-textarea:focus {
  outline: none;
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.form-textarea {
  resize: vertical;
  min-height: 80px;
}

.step-card {
  background: #f8fafc;
  border: 1px solid #e2e8f0;
  border-radius: 8px;
  padding: 1.5rem;
  margin-bottom: 1rem;
  cursor: grab;
  transition: all 0.2s;
}

.step-card:hover {
  border-color: #cbd5e1;
}

.step-card.dragging {
  opacity: 0.5;
  transform: rotate(2deg);
}

.step-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
}

.step-number {
  background: #3b82f6;
  color: white;
  width: 24px;
  height: 24px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.8rem;
  font-weight: 600;
}

.btn-danger {
  background: #ef4444;
  color: white;
  padding: 0.5rem;
  border-radius: 6px;
}

.btn-danger:hover {
  background: #dc2626;
}

.options-list, .subflows-list {
  background: white;
  border: 1px solid #e2e8f0;
  border-radius: 6px;
  padding: 1rem;
  margin: 1rem 0;
}

.option-item, .subflow-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.5rem 0;
  border-bottom: 1px solid #f1f5f9;
}

.option-item:last-child, .subflow-item:last-child {
  border-bottom: none;
}

.inline-form {
  display: flex;
  gap: 0.5rem;
  margin-top: 1rem;
}

.inline-form input, .inline-form select {
  flex: 1;
  padding: 0.5rem;
  border: 1px solid #e2e8f0;
  border-radius: 6px;
  font-size: 0.85rem;
}

.json-output {
  background: #1e293b;
  color: #e2e8f0;
  padding: 1.5rem;
  border-radius: 12px;
  font-family: 'Courier New', monospace;
  font-size: 0.85rem;
  line-height: 1.5;
  overflow-x: auto;
  white-space: pre;
}

.empty-state {
  text-align: center;
  padding: 4rem 2rem;
  color: #64748b;
}

.empty-state h3 {
  font-size: 1.25rem;
  margin-bottom: 0.5rem;
  color: #475569;
}

.warning {
  background: #fef3c7;
  color: #92400e;
  padding: 0.75rem;
  border-radius: 6px;
  margin: 1rem 0;
  font-size: 0.9rem;
}

.success {
  background: #dcfce7;
  color: #166534;
  padding: 0.75rem;
  border-radius: 6px;
  margin: 1rem 0;
  font-size: 0.9rem;
}

@media (max-width: 768px) {
  .modal {
    width: 100%;
  }
  
  .toolbar {
    flex-direction: column;
    align-items: stretch;
  }
  
  .toolbar input, .toolbar select {
    min-width: auto;
  }
  
  .flows-grid {
    grid-template-columns: 1fr;
  }
}
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>Flow Editor</h1>
    <p>Crea y gestiona tus flows y subflows de manera intuitiva</p>
  </div>

  <div class="toolbar">
    <input id="flowName" placeholder="Nombre del flow" class="form-input">
    <input id="flowId" placeholder="ID (ej: 1001)" class="form-input">
    <select id="flowType" class="form-select">
      <option value="main">Main Flow</option>
      <option value="subflow">Subflow</option>
    </select>
    <input id="flowTriggers" placeholder="Triggers (separados por coma)" class="form-input">
    <button id="createFlowBtn" class="btn btn-primary">‚ûï Crear Flow</button>
    <button id="exportJSONBtn" class="btn btn-secondary">üíæ Exportar</button>
    <button id="importJSONBtn" class="btn btn-secondary">üìÇ Importar</button>
  </div>

  <div id="flowsContainer" class="flows-grid"></div>

  <div class="json-output" id="output">// El JSON generado aparecer√° aqu√≠</div>
</div>

<div id="modalOverlay" class="modal-overlay">
  <div id="modal" class="modal">
    <div class="modal-header">
      <div class="modal-title" id="modalTitle">Editor de Flow</div>
      <div class="modal-subtitle" id="modalSubtitle">Configura los pasos de tu flow</div>
    </div>
    <div class="modal-content" id="modalContent">
      <!-- El contenido del editor se carga aqu√≠ -->
    </div>
  </div>
</div>

<input type="file" id="fileInput" style="display:none" accept=".json">

<script>
class FlowEditor {
  constructor() {
    this.data = JSON.parse(localStorage.getItem("flowsData") || "{}");
    this.currentEditing = null;
    this.initializeElements();
    this.bindEvents();
    this.render();
  }

  initializeElements() {
    this.flowsContainer = document.getElementById("flowsContainer");
    this.output = document.getElementById("output");
    this.modal = document.getElementById("modal");
    this.modalOverlay = document.getElementById("modalOverlay");
    this.modalTitle = document.getElementById("modalTitle");
    this.modalSubtitle = document.getElementById("modalSubtitle");
    this.modalContent = document.getElementById("modalContent");
  }

  bindEvents() {
    document.getElementById("flowType").addEventListener("change", (e) => {
      document.getElementById("flowTriggers").style.display = 
        e.target.value === "main" ? "block" : "none";
    });

    document.getElementById("createFlowBtn").addEventListener("click", () => this.createFlow());
    document.getElementById("exportJSONBtn").addEventListener("click", () => this.exportJSON());
    document.getElementById("importJSONBtn").addEventListener("click", () => this.importJSON());
    document.getElementById("fileInput").addEventListener("change", (e) => this.handleFile(e));
    
    this.modalOverlay.addEventListener("click", (e) => {
      if (e.target === this.modalOverlay) this.closeModal();
    });

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") this.closeModal();
    });
  }

  saveData() {
    localStorage.setItem("flowsData", JSON.stringify(this.data));
  }

  createFlow() {
    const name = document.getElementById("flowName").value.trim();
    const id = parseInt(document.getElementById("flowId").value.trim());
    const type = document.getElementById("flowType").value.trim();
    const triggers = document.getElementById("flowTriggers").value.trim();

    if (!name || isNaN(id)) {
      alert("Debes ingresar nombre e ID num√©rico");
      return;
    }

    if (Object.values(this.data).some(f => f.id === id)) {
      alert("ID duplicado");
      return;
    }

    this.data[name] = {
      type,
      id,
      ...(type === "main" && triggers ? {triggers: triggers.split(",").map(t => t.trim())} : {}),
      steps: []
    };

    // Limpiar formulario
    document.getElementById("flowName").value = "";
    document.getElementById("flowId").value = "";
    document.getElementById("flowTriggers").value = "";

    this.render();
    this.saveData();
  }

  render() {
    this.renderFlows();
    this.renderJSON();
  }

  renderFlows() {
    if (Object.keys(this.data).length === 0) {
      this.flowsContainer.innerHTML = `
        <div class="empty-state">
          <h3>No hay flows creados</h3>
          <p>Crea tu primer flow usando el formulario de arriba</p>
        </div>
      `;
      return;
    }

    this.flowsContainer.innerHTML = "";
    
    for (const [name, flow] of Object.entries(this.data)) {
      const card = document.createElement("div");
      card.className = `flow-card ${flow.type}`;
      card.innerHTML = `
        <div class="flow-title">${name}</div>
        <div class="flow-meta">
          <span class="flow-type ${flow.type}">${flow.type}</span>
          <span class="flow-id">ID: ${flow.id}</span>
        </div>
        <div class="flow-steps">${flow.steps.length} pasos configurados</div>
      `;
      card.addEventListener("click", () => this.openModal(name));
      this.flowsContainer.appendChild(card);
    }
  }

  openModal(flowName) {
    this.currentEditing = flowName;
    const flow = this.data[flowName];
    
    this.modalTitle.textContent = `Editando: ${flowName}`;
    this.modalSubtitle.textContent = `${flow.type.toUpperCase()} - ID: ${flow.id}`;
    
    this.renderModalContent(flowName, flow);
    
    this.modalOverlay.classList.add("active");
    this.modal.classList.add("active");
  }

  closeModal() {
    this.modalOverlay.classList.remove("active");
    this.modal.classList.remove("active");
    this.currentEditing = null;
  }

  renderModalContent(flowName, flow) {
    this.modalContent.innerHTML = `
      <div class="form-group">
        <label class="form-label">ID del Flow</label>
        <input type="number" class="form-input" value="${flow.id}" 
               onchange="editor.updateFlowProperty('${flowName}', 'id', parseInt(this.value) || 0)">
      </div>
      
      ${flow.type === "main" ? `
        <div class="form-group">
          <label class="form-label">Triggers</label>
          <input type="text" class="form-input" value="${flow.triggers ? flow.triggers.join(', ') : ''}" 
                 placeholder="Separados por coma"
                 onchange="editor.updateFlowProperty('${flowName}', 'triggers', this.value.split(',').map(t => t.trim()))">
        </div>
      ` : ''}
      
      <div class="form-group">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
          <label class="form-label" style="margin: 0;">Pasos del Flow</label>
          <button class="btn btn-primary" onclick="editor.addStep('${flowName}')">‚ûï Agregar Paso</button>
        </div>
        <div id="stepsContainer"></div>
      </div>
    `;

    this.renderSteps(flowName, flow);
  }

  renderSteps(flowName, flow) {
    const container = document.getElementById("stepsContainer");
    if (!container) return;

    if (flow.steps.length === 0) {
      container.innerHTML = `
        <div class="empty-state">
          <p>No hay pasos configurados</p>
        </div>
      `;
      return;
    }

    container.innerHTML = "";
    
    flow.steps.forEach((step, index) => {
      const stepCard = document.createElement("div");
      stepCard.className = "step-card";
      stepCard.draggable = true;
      
      stepCard.addEventListener("dragstart", (e) => {
        e.dataTransfer.setData("text/plain", index);
        stepCard.classList.add("dragging");
      });
      
      stepCard.addEventListener("dragend", () => {
        stepCard.classList.remove("dragging");
      });
      
      stepCard.addEventListener("dragover", (e) => e.preventDefault());
      
      stepCard.addEventListener("drop", (e) => {
        e.preventDefault();
        const draggedIndex = parseInt(e.dataTransfer.getData("text/plain"));
        this.reorderSteps(flowName, draggedIndex, index);
      });

      stepCard.innerHTML = `
        <div class="step-header">
          <div class="step-number">${step.step}</div>
          <button class="btn btn-danger" onclick="editor.deleteStep('${flowName}', ${index})">üóëÔ∏è</button>
        </div>
        
        <div class="form-group">
          <label class="form-label">Tipo de Paso</label>
          <select class="form-select" onchange="editor.changeStepType('${flowName}', ${index}, this.value)">
            <option value="question" ${step.type === "question" ? "selected" : ""}>Pregunta</option>
            <option value="options" ${step.type === "options" ? "selected" : ""}>Opciones</option>
            <option value="subflow" ${step.type === "subflow" ? "selected" : ""}>Subflow</option>
          </select>
        </div>
        
        <div class="form-group">
          <label class="form-label">Pregunta</label>
          <textarea class="form-textarea" 
                    onchange="editor.updateStepProperty('${flowName}', ${index}, 'question', this.value)">${step.question}</textarea>
        </div>
        
        <div class="form-group">
          <label class="form-label">Key (opcional)</label>
          <input type="text" class="form-input" value="${step.key || ''}" 
                 onchange="editor.updateStepProperty('${flowName}', ${index}, 'key', this.value || null)">
        </div>
        
        <div id="stepOptions-${index}"></div>
      `;
      
      container.appendChild(stepCard);
      this.renderStepOptions(flowName, step, index);
    });
  }

  renderStepOptions(flowName, step, index) {
    const container = document.getElementById(`stepOptions-${index}`);
    if (!container) return;

    if (step.type === "options") {
      let optionsHTML = '<div class="form-group"><label class="form-label">Opciones</label>';
      
      if (step.options && Object.keys(step.options).length > 0) {
        optionsHTML += '<div class="options-list">';
        for (const [opt, vals] of Object.entries(step.options)) {
          optionsHTML += `
            <div class="option-item">
              <span>"${opt}" : [${vals.map(v => `"${v}"`).join(", ")}]</span>
              <button class="btn btn-danger" onclick="editor.deleteOption('${flowName}', ${index}, '${opt}')">üóëÔ∏è</button>
            </div>
          `;
        }
        optionsHTML += '</div>';
      }
      
      optionsHTML += `
        <div class="inline-form">
          <input type="text" placeholder="Nombre opci√≥n" id="optName-${index}">
          <input type="text" placeholder="Valores (ej: 1,latte)" id="optValues-${index}">
          <button class="btn btn-primary" onclick="editor.saveOption('${flowName}', ${index})">‚ûï</button>
        </div>
      </div>`;
      
      container.innerHTML = optionsHTML;
    } else if (step.type === "subflow") {
      const availableSubflows = Object.values(this.data).filter(f => f.type === "subflow");
      
      let subflowHTML = '<div class="form-group"><label class="form-label">Subflows</label>';
      
      if (availableSubflows.length === 0) {
        subflowHTML += '<div class="warning">‚ö†Ô∏è No hay subflows creados.</div>';
      } else {
        if (step.subflows && Object.keys(step.subflows).length > 0) {
          subflowHTML += '<div class="subflows-list">';
          for (const [subId, vals] of Object.entries(step.subflows)) {
            subflowHTML += `
              <div class="subflow-item">
                <span>"${subId}" : [${vals.map(v => `"${v}"`).join(", ")}]</span>
                <button class="btn btn-danger" onclick="editor.deleteSubflow('${flowName}', ${index}, '${subId}')">üóëÔ∏è</button>
              </div>
            `;
          }
          subflowHTML += '</div>';
        }
        
        const selectableSubflows = availableSubflows.filter(f => !(step.subflows && step.subflows[f.id]));
        
        if (selectableSubflows.length > 0) {
          const options = selectableSubflows.map(f => `<option value="${f.id}">${f.id}</option>`).join("");
          subflowHTML += `
            <div class="inline-form">
              <select id="subId-${index}">${options}</select>
              <input type="text" placeholder="Valores (ej: 1,cafe)" id="subValues-${index}">
              <button class="btn btn-primary" onclick="editor.saveSubflow('${flowName}', ${index})">‚ûï</button>
            </div>
          `;
        } else {
          subflowHTML += '<div class="success">‚úÖ Todos los subflows disponibles ya fueron agregados.</div>';
        }
      }
      
      subflowHTML += '</div>';
      container.innerHTML = subflowHTML;
    } else {
      container.innerHTML = '';
    }
  }

  updateFlowProperty(flowName, property, value) {
    this.data[flowName][property] = value;
    this.render();
    this.saveData();
  }

  updateStepProperty(flowName, stepIndex, property, value) {
    this.data[flowName].steps[stepIndex][property] = value;
    this.render();
    this.saveData();
  }

  changeStepType(flowName, index, newType) {
    const step = this.data[flowName].steps[index];
    step.type = newType;
    
    if (newType === "options") {
      delete step.subflows;
      step.options = step.options || {};
    } else if (newType === "subflow") {
      delete step.options;
      step.subflows = step.subflows || {};
    } else {
      delete step.options;
      delete step.subflows;
    }
    
    this.renderModalContent(flowName, this.data[flowName]);
    this.render();
    this.saveData();
  }

  addStep(flowName) {
    const flow = this.data[flowName];
    flow.steps.push({
      step: flow.steps.length + 1,
      type: "question",
      question: "Nueva pregunta...",
      key: null
    });
    
    this.renderModalContent(flowName, flow);
    this.render();
    this.saveData();
  }

  deleteStep(flowName, stepIndex) {
    const flow = this.data[flowName];
    flow.steps.splice(stepIndex, 1);
    flow.steps.forEach((s, i) => s.step = i + 1);
    
    this.renderModalContent(flowName, flow);
    this.render();
    this.saveData();
  }

  reorderSteps(flowName, fromIndex, toIndex) {
    const flow = this.data[flowName];
    const steps = flow.steps;
    const temp = steps[fromIndex];
    steps.splice(fromIndex, 1);
    steps.splice(toIndex, 0, temp);
    steps.forEach((s, i) => s.step = i + 1);
    
    this.renderModalContent(flowName, flow);
    this.render();
    this.saveData();
  }

  saveOption(flowName, stepIndex) {
    const optName = document.getElementById(`optName-${stepIndex}`).value.trim();
    const optValues = document.getElementById(`optValues-${stepIndex}`).value.trim();
    
    if (!optName || !optValues) return;
    
    const step = this.data[flowName].steps[stepIndex];
    if (!step.options) step.options = {};
    step.options[optName] = optValues.split(",").map(v => v.trim());
    
    document.getElementById(`optName-${stepIndex}`).value = "";
    document.getElementById(`optValues-${stepIndex}`).value = "";
    
    this.renderModalContent(flowName, this.data[flowName]);
    this.render();
    this.saveData();
  }

  deleteOption(flowName, stepIndex, optName) {
    delete this.data[flowName].steps[stepIndex].options[optName];
    this.renderModalContent(flowName, this.data[flowName]);
    this.render();
    this.saveData();
  }

  saveSubflow(flowName, stepIndex) {
    const subId = document.getElementById(`subId-${stepIndex}`).value;
    const values = document.getElementById(`subValues-${stepIndex}`).value.trim();
    
    if (!values) return;
    
    const exists = Object.values(this.data).some(f => f.type === "subflow" && f.id == subId);
    if (!exists) {
      alert("‚ö†Ô∏è No existe el subflow con id " + subId);
      return;
    }
    
    const step = this.data[flowName].steps[stepIndex];
    if (!step.subflows) step.subflows = {};
    step.subflows[subId] = values.split(",").map(v => v.trim());
    
    document.getElementById(`subValues-${stepIndex}`).value = "";
    
    this.renderModalContent(flowName, this.data[flowName]);
    this.render();
    this.saveData();
  }

  deleteSubflow(flowName, stepIndex, subId) {
    delete this.data[flowName].steps[stepIndex].subflows[subId];
    this.renderModalContent(flowName, this.data[flowName]);
    this.render();
    this.saveData();
  }

  renderJSON() {
    const cleanData = JSON.parse(JSON.stringify(this.data, (key, value) => {
      if (key === "id") return Number(value);
      if (key === "key" && (value === "" || value === undefined)) return null;
      return value;
    }));
    
    this.output.textContent = JSON.stringify(cleanData, null, 2);
  }

  exportJSON() {
    const blob = new Blob([JSON.stringify(this.data, null, 2)], {type: "application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "flows.json";
    a.click();
    URL.revokeObjectURL(url);
  }

  importJSON() {
    document.getElementById("fileInput").click();
  }

  handleFile(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = () => {
      try {
        this.data = JSON.parse(reader.result);
        this.render();
        this.saveData();
        alert("‚úÖ JSON importado correctamente");
      } catch (err) {
        alert("‚ùå Error al importar JSON");
      }
    };
    reader.readAsText(file);
  }
}

const editor = new FlowEditor();
</script>

</body>
</html>